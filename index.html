<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>덕소고 방사선&전자파 위험 지도</title>
  <style>
    body {
      font-family: NanumSquareRound, sans-serif;
      text-align: center;
      margin: 40px;
      user-select: none;
    }
    #svg-frame {
      width: 90%;
      max-width: 2500px;
      height: 600px;
      border: 1px solid #ccc;
      margin: 0 auto;
      display: block;
      overflow: hidden;
      cursor: grab;
      touch-action: none; /* 터치 기본 동작 막기 */
    }
  </style>
</head>
<body>

<h1>덕소고 방사선&전자파 위험 지도</h1>

<div id="building-buttons">
  <button onclick="selectBuilding('gm')">근면관</button>
  <button onclick="selectBuilding('sm')">소망관</button>
  <button onclick="selectBuilding('md')">믿음관</button>
</div>

<div id="floor-buttons" style="display:none; margin-top: 20px;">
  <button onclick="changeFloor(1)">1층</button>
  <button onclick="changeFloor(2)">2층</button>
  <button onclick="changeFloor(3)">3층</button>
  <button onclick="changeFloor(4)">4층</button>
</div>

<iframe id="svg-frame" src="gm_floor1.svg" frameborder="0" scrolling="no"></iframe>

<div id="description" style="margin-top: 20px; font-size: 18px; color: #333;"></div>

<script>
  let currentBuilding = 'gm';

  function selectBuilding(code) {
    currentBuilding = code;
    document.getElementById('floor-buttons').style.display = 'block';
    changeFloor(1);
  }

  function changeFloor(floorNum) {
    const iframe = document.getElementById('svg-frame');
    iframe.src = `${currentBuilding}_floor${floorNum}.svg`;
    document.getElementById('description').innerText = '';
    resetTransform();
  }

  const iframe = document.getElementById('svg-frame');

  let scale = 1;
  const scaleStep = 0.1;
  const minScale = 0.5;
  const maxScale = 4;

  let translateX = 0;
  let translateY = 0;

  let isDragging = false;
  let dragStartX = 0;
  let dragStartY = 0;
  let lastTranslateX = 0;
  let lastTranslateY = 0;

  // 핀치 줌 관련 변수
  let isPinching = false;
  let pinchStartDist = 0;
  let pinchStartScale = 1;
  let pinchCenter = { x: 0, y: 0 };
  let lastTranslateDuringPinch = { x: 0, y: 0 };

  function getDistance(touch1, touch2) {
    return Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
  }

  function getCenter(touch1, touch2) {
    return {
      x: (touch1.clientX + touch2.clientX) / 2,
      y: (touch1.clientY + touch2.clientY) / 2
    };
  }

  function resetTransform() {
    scale = 1;
    translateX = 0;
    translateY = 0;
  }

  iframe.addEventListener('load', () => {
    const svgDoc = iframe.contentDocument || iframe.contentWindow.document;
    if (!svgDoc) return;

    const svg = svgDoc.querySelector('svg');
    if (!svg) return;

    updateTransform();

    const targets = [
      { id: 'tclass', text: '여기는 교무실입니다.' },
      { id: 'class308', text: '여기는 3학년 8반 교실입니다.' },
      { id: 'class311', text: '여기는 3학년 11반 교실입니다.' },
      { id: 'class303', text: '여기는 3학년 3반 교실입니다.' }
    ];

    targets.forEach(({ id, text }) => {
      const el = svgDoc.getElementById(id);
      if (el) {
        el.style.cursor = 'pointer';
        el.addEventListener('click', () => {
          document.getElementById('description').innerText = text;
        });
      }
    });

    // 휠 확대/축소
    svg.addEventListener('wheel', (event) => {
      event.preventDefault();

      const rect = svg.getBoundingClientRect();
      const offsetX = event.clientX - rect.left;
      const offsetY = event.clientY - rect.top;

      let newScale = scale;
      if (event.deltaY < 0) {
        newScale = Math.min(scale + scaleStep, maxScale);
      } else {
        newScale = Math.max(scale - scaleStep, minScale);
      }

      const scaleRatio = newScale / scale;

      translateX = offsetX - scaleRatio * (offsetX - translateX);
      translateY = offsetY - scaleRatio * (offsetY - translateY);

      scale = newScale;
      updateTransform();
    });

    // 마우스 드래그
    svg.addEventListener('mousedown', (event) => {
      event.preventDefault();
      isDragging = true;
      dragStartX = event.clientX;
      dragStartY = event.clientY;
      lastTranslateX = translateX;
      lastTranslateY = translateY;
      svg.style.cursor = 'grabbing';
    });

    svg.addEventListener('mousemove', (event) => {
      if (!isDragging) return;
      event.preventDefault();

      const dx = event.clientX - dragStartX;
      const dy = event.clientY - dragStartY;

      translateX = lastTranslateX + dx;
      translateY = lastTranslateY + dy;
      updateTransform();
    });

    svg.addEventListener('mouseup', (event) => {
      if (!isDragging) return;
      event.preventDefault();
      isDragging = false;
      svg.style.cursor = 'grab';
    });

    svg.addEventListener('mouseleave', (event) => {
      if (!isDragging) return;
      event.preventDefault();
      isDragging = false;
      svg.style.cursor = 'grab';
    });

    // 터치 이벤트: 드래그 및 핀치 줌

    svg.addEventListener('touchstart', (event) => {
      if (event.touches.length === 1) {
        // 한 손가락 드래그 시작
        isDragging = true;
        dragStartX = event.touches[0].clientX;
        dragStartY = event.touches[0].clientY;
        lastTranslateX = translateX;
        lastTranslateY = translateY;
        svg.style.cursor = 'grabbing';
      } else if (event.touches.length === 2) {
        // 두 손가락 핀치 시작
        isPinching = true;
        pinchStartDist = getDistance(event.touches[0], event.touches[1]);
        pinchStartScale = scale;
        pinchCenter = getCenter(event.touches[0], event.touches[1]);
        lastTranslateDuringPinch = { x: translateX, y: translateY };
      }
    });

    svg.addEventListener('touchmove', (event) => {
      if (isPinching && event.touches.length === 2) {
        event.preventDefault();
        const newDist = getDistance(event.touches[0], event.touches[1]);
        let newScale = pinchStartScale * (newDist / pinchStartDist);
        newScale = Math.min(maxScale, Math.max(minScale, newScale));

        const scaleRatio = newScale / scale;

        // 핀치 중심 기준으로 translate 조정
        translateX = pinchCenter.x - scaleRatio * (pinchCenter.x - lastTranslateDuringPinch.x);
        translateY = pinchCenter.y - scaleRatio * (pinchCenter.y - lastTranslateDuringPinch.y);

        scale = newScale;
        updateTransform();

      } else if (isDragging && event.touches.length === 1) {
        event.preventDefault();

        const dx = event.touches[0].clientX - dragStartX;
        const dy = event.touches[0].clientY - dragStartY;

        translateX = lastTranslateX + dx;
        translateY = lastTranslateY + dy;
        updateTransform();
      }
    });

    svg.addEventListener('touchend', (event) => {
      if (event.touches.length === 0) {
        // 모든 터치 종료
        isDragging = false;
        isPinching = false;
        svg.style.cursor = 'grab';
      } else if (event.touches.length === 1) {
        // 두 손가락에서 한 손가락으로 전환
        isPinching = false;
        isDragging = true;
        dragStartX = event.touches[0].clientX;
        dragStartY = event.touches[0].clientY;
        lastTranslateX = translateX;
        lastTranslateY = translateY;
        svg.style.cursor = 'grabbing';
      }
    });

    svg.addEventListener('touchcancel', (event) => {
      isDragging = false;
      isPinching = false;
      svg.style.cursor = 'grab';
    });
  });

  function updateTransform() {
    const svgDoc = iframe.contentDocument || iframe.contentWindow.document;
    if (!svgDoc) return;
    const svg = svgDoc.querySelector('svg');
    if (!svg) return;

    svg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
  }
</script>

</body>
</html>
